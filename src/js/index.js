function firstEnter(){setVolume(.7),getMusic(),getChannelData()}function getChannelData(){$.ajax({type:"get",url:"http://api.jirengu.com/fm/getChannels.php",dataType:"jsonp",jsonp:"callback"}).done(function(e){renderChannel(e)}).fail(function(){alert("数据获取失败！")})}function getMusic(){$.ajax({type:"get",url:"http://api.jirengu.com/fm/getSong.php",dataType:"jsonp",jsonp:"callback",data:{channel:storageChannel}}).done(function(e){null==e.song[0].url?getMusic():getMusicInfor(e)}).fail(function(){console.log("music erro")})}function getMusicInfor(e){$musicBg.css("background-image","url("+e.song[0].picture+")"),$musicTitle.text(e.song[0].title),$musicAuthor.text(e.song[0].artist),musicSid=e.song[0].sid,getLyric(),audioObject.src=e.song[0].url,audioObject.play()}function setVolume(e){$volumeBarNow.animate({width:100*e+"%"}),audioObject.volume=e}function setBar(e,n,t){var i=parseInt(e.css("width"));n.css({width:i*t})}function setTime(e,n){var t=timeConver(e);n.text(t)}function timeConver(e){var n=parseInt(e/60),t=parseInt(e%60);return n<10&&(n="0"+n),t<10&&(t="0"+t),timer=n+":"+t,timer}function setProcess(e){audioObject.currentTime=e*audioObject.duration}function renderChannel(e){var n="";$.each(e.channels,function(e,t){n+='<li channelId="'+t.channel_id+'">'+t.name+"</li>"}),$channelsUl.empty(),$(n).appendTo($channelsUl)}function getLyric(){$.ajax({url:"http://api.jirengu.com/fm/getLyric.php",type:"post",dataType:"json",jsonp:"callback",data:{sid:musicSid}}).done(function(e){dealLrc(e.lyric),renderLyric()}).fail(function(){console.log("获取歌词失败")})}function dealLrc(e){if(e){var n=e.split("\n"),t=/\[\d{2}:\d{2}.\d{2}\]/g,i=[];if(""!=n)for(var o in n){var a=n[o].match(t),c=n[o].replace(t,"");for(var r in a){var s=a[r].slice(1,-1).split(":"),l=60*parseInt(s[0],10)+parseFloat(s[1]);i.push([l,c])}}}i.shift(),i.sort(function(e,n){return e[0]-n[0]}),lyricArr=i}function renderLyric(){for(var e="",n=0;n<lyricArr.length;n++)""!==lyricArr[n][1]&&(e+='<li data-time="'+lyricArr[n][0]+'">'+lyricArr[n][1]+"</li>");$lyricUl.empty(),$(e).appendTo($lyricUl)}function showLyric(){for(var e=$(".lyric>ul>li"),n=0;n<lyricArr.length;n++){var t=e.eq(n).attr("data-time"),i=e.eq(n+1).attr("data-time"),o=audioObject.currentTime;if(o>t&&o<i){for(var a=0,c=0;c<=n;c++)a+=e.eq(c).outerHeight(!0);e.removeClass("active"),e.eq(n).addClass("active"),$(".lyric>ul").css({top:50-a})}}}var audioObject=new Audio,$channelsList=$(".header>.channels-list"),$channelsUl=$(".header>.channels-list>ul"),$musicTitle=$(".infor>.title"),$musicAuthor=$(".infor>.author"),$musicBg=$(".music-box .header"),$volumeBar=$(".volume-bar"),$volumeBarNow=$(".volume-bar-now"),$horn=$(".volume>.horn"),$next=$(".btn>.next"),$last=$(".btn>.last"),$play=$(".btn .play-btn"),$pause=$(".btn .pause-btn"),$timeNow=$(".process>.time-now"),$timeTotal=$(".process>.time-total"),$processBar=$(".process-bar"),$processBarNow=$(".process-bar-now"),$lyricUl=$(".lyric>ul"),storageChannel="public_tuijian_rege",musicSid,lyricArr=[];firstEnter(),$(audioObject).on("ended",function(){getMusic()}),$(audioObject).on("playing",function(){setTime(audioObject.currentTime,$timeNow),setTime(audioObject.duration,$timeTotal)}),audioObject.ontimeupdate=function(){setTime(audioObject.currentTime,$timeNow);var e=Math.ceil(audioObject.currentTime)/Math.ceil(audioObject.duration);showLyric(),setBar($processBar,$processBarNow,e)},$next.on("click",function(){getMusic()}),$pause.on("click",function(){audioObject.pause(),$play.css("display","inline-block"),$pause.css("display","none")}),$play.on("click",function(){audioObject.play(),$pause.css("display","inline-block"),$play.css("display","none")}),$volumeBar.on("click",function(e){setVolume(e.offsetX/$volumeBar.width())}),$horn.on("click",function(){$horn.hasClass("icon-VolumeMaxIcon")?setVolume(0):$horn.hasClass("icon-VolumeOffIcon")&&setVolume(.7),$horn.toggleClass("icon-VolumeMaxIcon"),$horn.toggleClass("icon-VolumeOffIcon")}),$channelsUl.on("click","li",function(e){if("li"===e.target.tagName.toLowerCase()){var n=$(e.target);storageChannel=n.attr("channelId"),getMusic()}}),$(".icon-menu").on("click",function(){$(".channels-list").toggle()}),$(".icon-lyric").on("click",function(){$(".lyric").toggle()}),$processBar.on("click",function(e){var n=e.offsetX/$processBar.width();setProcess(n),setBar($processBar,$processBarNow,n)});